---
title: "Berlin Firms Comparison - Table"
output:
  word_document:
    toc: false
    number_sections: false
    df_print: default
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Load required libraries
library(tidyverse)
library(knitr)

# Load data
df <- readRDS("/workspaces/rct25/data/generated/Orbis_Berlin_Data/orbis_panel_berlin.rds")

stopifnot(is.data.frame(df))

# Clean and prepare data
df <- df %>%
  filter(city_native == "Berlin") %>%
  mutate(
    total_assets = toas,
    equity_ratio = shfd / toas,
    log_total_assets = log1p(toas),
    group = if_else(postcode == 10437, "Postal Code 10437", "Other Berlin Firms")
  ) %>%
  filter(!is.na(total_assets), !is.na(equity_ratio))

n_total_original <- nrow(df)
df <- df %>% filter(total_assets >= 1000)
n_removed_assets <- n_total_original - nrow(df)

# Summary stats
summary_stats <- df %>%
  group_by(group) %>%
  summarise(
    Mean_Total_Assets = mean(total_assets, na.rm = TRUE),
    SD_Total_Assets = sd(total_assets, na.rm = TRUE),
    Mean_Equity_Ratio = mean(equity_ratio, na.rm = TRUE),
    Median_Equity_Ratio = median(equity_ratio, na.rm = TRUE),
    SD_Equity_Ratio = sd(equity_ratio, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

get_stat <- function(var, group_name) summary_stats %>% filter(group == group_name) %>% pull({{ var }})

# Extract values
mean_total_assets_10437 <- get_stat(Mean_Total_Assets, "Postal Code 10437")
mean_total_assets_other <- get_stat(Mean_Total_Assets, "Other Berlin Firms")
mean_equity_ratio_10437 <- get_stat(Mean_Equity_Ratio, "Postal Code 10437")
mean_equity_ratio_other <- get_stat(Mean_Equity_Ratio, "Other Berlin Firms")
median_equity_ratio_10437 <- get_stat(Median_Equity_Ratio, "Postal Code 10437")
median_equity_ratio_other <- get_stat(Median_Equity_Ratio, "Other Berlin Firms")
sd_equity_ratio_10437 <- get_stat(SD_Equity_Ratio, "Postal Code 10437")
sd_equity_ratio_other <- get_stat(SD_Equity_Ratio, "Other Berlin Firms")
sd_total_assets_10437 <- get_stat(SD_Total_Assets, "Postal Code 10437")
sd_total_assets_other <- get_stat(SD_Total_Assets, "Other Berlin Firms")
n_10437 <- get_stat(n, "Postal Code 10437")
n_other <- get_stat(n, "Other Berlin Firms")

# Statistical tests
t_total_assets <- t.test(total_assets ~ group, data = df)
t_equity_ratio <- t.test(equity_ratio ~ group, data = df)
t_sd_equity_ratio <- t.test(df$equity_ratio[df$group == "Postal Code 10437"], df$equity_ratio[df$group != "Postal Code 10437"])
t_sd_total_assets <- t.test(df$total_assets[df$group == "Postal Code 10437"], df$total_assets[df$group != "Postal Code 10437"])
t_median_equity_ratio <- wilcox.test(equity_ratio ~ group, data = df)
```

```{r table-only, echo=FALSE, message=FALSE, warning=FALSE}
# Results table
results_table <- tibble(
  rowname = c(
    "Total Assets (Mean)",
    "Total Assets (SD)",
    "Equity Ratio (Mean)",
    "Equity Ratio (Median)",
    "Equity Ratio (SD)",
    "Number of Firms (N)"
  ),
  `Postal Code 10437` = c(
    mean_total_assets_10437,
    sd_total_assets_10437,
    mean_equity_ratio_10437,
    median_equity_ratio_10437,
    sd_equity_ratio_10437,
    n_10437
  ),
  `Other Berlin Firms` = c(
    mean_total_assets_other,
    sd_total_assets_other,
    mean_equity_ratio_other,
    median_equity_ratio_other,
    sd_equity_ratio_other,
    n_other
  ),
  Difference = c(
    mean_total_assets_10437 - mean_total_assets_other,
    sd_total_assets_10437 - sd_total_assets_other,
    mean_equity_ratio_10437 - mean_equity_ratio_other,
    median_equity_ratio_10437 - median_equity_ratio_other,
    sd_equity_ratio_10437 - sd_equity_ratio_other,
    NA
  ),
  `P-Value` = c(
    t_total_assets$p.value,
    t_sd_total_assets$p.value,
    t_equity_ratio$p.value,
    t_median_equity_ratio$p.value,
    t_sd_equity_ratio$p.value,
    NA
  ),
  Significance = c(
    case_when(t_total_assets$p.value < 0.01 ~ "***", t_total_assets$p.value < 0.05 ~ "**", t_total_assets$p.value < 0.1 ~ "*", TRUE ~ ""),
    case_when(t_sd_total_assets$p.value < 0.01 ~ "***", t_sd_total_assets$p.value < 0.05 ~ "**", t_sd_total_assets$p.value < 0.1 ~ "*", TRUE ~ ""),
    case_when(t_equity_ratio$p.value < 0.01 ~ "***", t_equity_ratio$p.value < 0.05 ~ "**", t_equity_ratio$p.value < 0.1 ~ "*", TRUE ~ ""),
    case_when(t_median_equity_ratio$p.value < 0.01 ~ "***", t_median_equity_ratio$p.value < 0.05 ~ "**", t_median_equity_ratio$p.value < 0.1 ~ "*", TRUE ~ ""),
    case_when(t_sd_equity_ratio$p.value < 0.01 ~ "***", t_sd_equity_ratio$p.value < 0.05 ~ "**", t_sd_equity_ratio$p.value < 0.1 ~ "*", TRUE ~ ""),
    ""
  )
)

# Format numbers
results_table <- results_table %>%
  mutate(
    across(c(`Postal Code 10437`, `Other Berlin Firms`, Difference), ~
      case_when(
        str_detect(rowname, "Equity") ~ paste0(formatC(100 * ., format = "f", digits = 2, big.mark = ".", decimal.mark = ","), "%"),
        TRUE ~ formatC(., format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
      )
    ),
    `P-Value` = case_when(
      is.na(`P-Value`) ~ "",
      `P-Value` < 0.001 ~ "<0.001",
      TRUE ~ formatC(`P-Value`, format = "f", digits = 3, decimal.mark = ",")
    )
  )

# Print using kable only
kable(results_table, format = "markdown", align = "c", caption = "Comparison of Firms in Postal Code 10437 vs. Other Berlin Firms")
```
